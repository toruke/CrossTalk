services:
  # Traefik Service (Reverse Proxy & SSL)
  traefik:
    image: traefik:v3.0
    restart: always
    ports:
      - "80:80"
      - "443:443"
      # - "8080:8080" # Dashboard (Secure it or disable in prod)
    command:
      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Global HTTP -> HTTPS Redirection
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # SSL (Let's Encrypt)
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=${ACME_EMAIL}" # Email for cert expiry warnings
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - dmz_net  # Traefik on DMZ only (cannot access DB)

  # Database Service
  db:
    restart: always

  # Backend Service
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    environment:
      NODE_ENV: production
    labels:
      - "traefik.enable=true"
      # Router: Match /api prefix
      - "traefik.http.routers.api.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=myresolver"
      # Middleware: Strip /api prefix before sending to backend
      - "traefik.http.middlewares.api-strip.stripprefix.prefixes=/api"
      - "traefik.http.routers.api.middlewares=api-strip"
      # Service: Port 4000
      - "traefik.http.services.api.loadbalancer.server.port=4000"
    command: sh -c "npx prisma db push --accept-data-loss && npm start"

  # Frontend Service
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    restart: always
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: /api
    labels:
      - "traefik.enable=true"
      # Router: Match root domain
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=myresolver"
      # Service: Port 3000
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

networks:
  dmz_net:  # Inherited from base compose file
  data_net:  # Inherited from base compose file
